<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nebula Fractal Visualizer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{overflow:hidden;background:#000;color:white;height:100vh;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
header{padding:15px 20px;background:rgba(0,0,0,0.85);border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;z-index:100;position:relative;}
h1{font-size:1.8rem;background:linear-gradient(45deg,#ff00cc,#3333ff,#00ccff,#00ff9d);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700;}
.controls{display:flex;gap:12px;align-items:center;}
button{background: linear-gradient(45deg,#2c2c3a,#1a1a25); color:white; border:1px solid rgba(255,255,255,0.15); padding:8px 16px; border-radius:30px; cursor:pointer; font-family:inherit; font-weight:500; transition:all 0.2s; display:flex; align-items:center; gap:8px;}
button:hover:not(:disabled){transform:translateY(-1px);}
button:active:not(:disabled){transform:translateY(1px);}
button.primary{background: linear-gradient(45deg,#6a11cb,#2575fc);border:none;}
button.danger{background: linear-gradient(45deg,#ff416c,#ff4b2b);}
button:disabled{opacity:0.6; cursor:not-allowed; transform:none;}
.mode-indicator{padding:4px 12px;border-radius:20px;font-size:0.85rem;font-weight:500;background:rgba(100,100,100,0.15);border:1px solid rgba(150,150,150,0.3);}
.mode-mic{background: rgba(255,100,100,0.15); border-color: rgba(255,100,100,0.4);}
.mode-tab{background: rgba(100,150,255,0.15); border-color: rgba(100,150,255,0.4);}
canvas{display:block;position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;}
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,5,15,0.92);z-index:10;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;transition:opacity 0.4s ease;}
.overlay.hidden{opacity:0;pointer-events:none;}
.overlay h2{font-size:3.2rem;margin-bottom:20px;background:linear-gradient(45deg,#ff00cc,#3333ff,#00ccff,#00ff9d);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 15px rgba(100,200,255,0.6);}
.instructions{background: rgba(20,25,40,0.85); border:1px solid rgba(100,150,255,0.3); border-radius:15px; padding:25px; max-width:650px; margin:20px;}
.instructions h3{color:#6a5af9;margin-bottom:15px; display:flex;align-items:center; gap:10px; justify-content:center;}
.instructions ul{ text-align:left; padding-left:25px; margin-top:10px; line-height:1.6;}
.instructions li{margin-bottom:8px;}
.browser-warning{background: rgba(40,20,20,0.8); border:1px solid rgba(255,100,100,0.4); border-radius:12px; padding:18px; margin-top:25px; max-width:600px;}
footer{position:absolute; bottom:20px; width:100%; text-align:center; z-index:20; color:rgba(255,255,255,0.6); font-size:0.9rem; padding:0 20px;}
@media(max-width:768px){ .controls{flex-direction:column;align-items:stretch;gap:10px;} .overlay h2{font-size:2.3rem;} button{width:100%;justify-content:center;} }
</style>
</head>
<body>
<header>
<h1>NEBULA FRACTAL VISUALIZER</h1>
<div class="controls">
<div class="mode-indicator" id="modeIndicator">No Audio Source</div>
<button id="micButton" class="primary">üé§ Microphone</button>
<button id="tabButton">üñ•Ô∏è Tab Audio</button>
<button id="stopButton" class="danger" disabled>‚èπÔ∏è Stop</button>
</div>
</header>

<canvas id="visualizer"></canvas>

<div class="overlay" id="welcomeOverlay">
<h2>Nebula Fractal Visualizer</h2>
<div class="instructions">
<h3>How to Use</h3>
<ul>
<li><strong>Microphone:</strong> Visualize your voice or external audio</li>
<li><strong>Tab Audio (Chrome/Edge):</strong> Visualize audio playing in another tab</li>
<li>Visualizer reacts to bass, mids, and treble frequencies in real-time</li>
<li>Click "Stop" anytime to pause audio analysis</li>
</ul>
</div>
<div class="browser-warning">‚ö†Ô∏è Tab audio requires Chrome/Edge; browsers cannot access system audio directly.</div>
</div>

<footer>
<p>Fractal Recursive Nebula ‚Ä¢ 120 FPS ‚Ä¢ Audio Reactive ‚Ä¢ Particles + Swirls</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded',()=>{
const canvas=document.getElementById('visualizer'), ctx=canvas.getContext('2d',{alpha:false});
const welcomeOverlay=document.getElementById('welcomeOverlay');
const micButton=document.getElementById('micButton');
const tabButton=document.getElementById('tabButton');
const stopButton=document.getElementById('stopButton');
const modeIndicator=document.getElementById('modeIndicator');

function resizeCanvas(){canvas.width=window.innerWidth; canvas.height=window.innerHeight;}
window.addEventListener('resize',resizeCanvas); resizeCanvas();

let audioContext=null, analyzer=null, sourceNode=null, stream=null;
let animationFrameId=null, isVisualizing=false;
const PARTICLE_COUNT=100, FFT_SIZE=1024, SMOOTHING=0.85;
const particles=[], TARGET_FPS=120, FRAME_DURATION=1000/TARGET_FPS; let lastFrameTime=performance.now();
let hueOffset=0, swirlAngle=0;

// Particle class
class Particle{
constructor(){ this.reset(); }
reset(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.size=Math.random()*2+1; this.speedX=(Math.random()-0.5)*0.5; this.speedY=(Math.random()-0.5)*0.5; this.hue=Math.random()*360; this.alpha=Math.random()*0.4+0.2; this.life=1; this.angle=Math.random()*Math.PI*2;}
update(intensity,freqData){ 
this.angle+=0.002+intensity*0.03; this.x+=Math.cos(this.angle)*0.3; this.y+=Math.sin(this.angle)*0.3;
this.speedX+=(Math.random()-0.5)*intensity*0.1; this.speedY+=(Math.random()-0.5)*intensity*0.1;
this.x+=this.speedX; this.y+=this.speedY;
this.speedX*=0.95; this.speedY*=0.95;
if(this.x<0||this.x>canvas.width)this.speedX*=-1;
if(this.y<0||this.y>canvas.height)this.speedY*=-1;
this.life-=0.001; if(this.life<=0)this.reset();
const freqIndex=Math.floor((this.x/canvas.width)*(freqData.length-1));
const freqValue=freqData[Math.min(freqIndex,freqData.length-1)]||0;
this.hue=(freqValue/255)*360 + hueOffset;
}
draw(ctx){ctx.beginPath(); ctx.arc(this.x,this.y,this.size*2,0,Math.PI*2); ctx.fillStyle=`hsla(${this.hue%360},85%,65%,${this.alpha*this.life})`; ctx.fill();}
}
for(let i=0;i<PARTICLE_COUNT;i++)particles.push(new Particle());

// Recursive fractal function
function drawFractal(x,y,size,angle,depth,intensity){
if(depth<=0 || size<1)return;
ctx.strokeStyle=`hsla(${(hueOffset+depth*40)%360},80%,60%,${0.05+intensity*0.2})`;
ctx.lineWidth=Math.max(1,depth*0.6); ctx.beginPath(); ctx.moveTo(x,y);
const newX=x+Math.cos(angle)*size; const newY=y+Math.sin(angle)*size; ctx.lineTo(newX,newY); ctx.stroke();
const branchCount=2+Math.floor(intensity*2);
for(let i=0;i<branchCount;i++){
const newAngle=angle+(-0.5+Math.random())*Math.PI/2;
drawFractal(newX,newY,size*0.7,newAngle,depth-1,intensity);
}
}

// Swirling nebula
function drawSwirl(intensity){
const cx=canvas.width/2, cy=canvas.height/2; const radius=Math.min(canvas.width,canvas.height)/2.5;
for(let i=0;i<6;i++){
ctx.beginPath();
ctx.arc(cx,cy,radius+i*20+Math.sin(swirlAngle+i)*30,0,Math.PI*2);
ctx.strokeStyle=`hsla(${(hueOffset+i*60)%360},70%,50%,${0.03+intensity*0.08})`; ctx.lineWidth=2; ctx.stroke();
}
swirlAngle+=0.002+intensity*0.01;
}

// Draw loop
function drawVisualizer(timestamp){
if(!analyzer||!isVisualizing)return;
const delta=timestamp-lastFrameTime; if(delta<FRAME_DURATION){ animationFrameId=requestAnimationFrame(drawVisualizer); return; }
lastFrameTime=timestamp;

const bufferLength=analyzer.frequencyBinCount; const freqData=new Uint8Array(bufferLength); analyzer.getByteFrequencyData(freqData);
const timeData=new Uint8Array(analyzer.fftSize); analyzer.getByteTimeDomainData(timeData);
let sum=0; for(let i=0;i<bufferLength;i++)sum+=freqData[i]; const intensity=Math.min(1,sum/bufferLength/180);
hueOffset+=0.4;

// Background fade
ctx.globalCompositeOperation='source-over'; ctx.fillStyle=`rgba(0,0,20,0.12)`; ctx.fillRect(0,0,canvas.width,canvas.height);
ctx.globalCompositeOperation='lighter';

// Swirls
drawSwirl(intensity);

// Particles
for(let p of particles){ p.update(intensity,freqData); p.draw(ctx); }

// Fractals from center
const centerX=canvas.width/2, centerY=canvas.height/2;
drawFractal(centerX,centerY,80+intensity*50,Math.random()*Math.PI*2,5,intensity);
drawFractal(centerX,centerY,50+intensity*30,Math.random()*Math.PI*2,4,intensity);

// Frequency bars
const barCount=Math.min(128,bufferLength), barWidth=canvas.width/barCount, centerY2=canvas.height/2;
for(let i=0;i<barCount;i++){
const barHeight=(freqData[i]/255)*(canvas.height*0.5)*(0.7+intensity*0.5);
const hue=(i/barCount*360 + hueOffset)%360;
ctx.fillStyle=`hsla(${hue},90%,60%,${0.5+intensity*0.3})`;
ctx.fillRect(i*barWidth,centerY2-barHeight/2,barWidth-1.5,barHeight);
}

// Waveform
ctx.beginPath(); const sliceWidth=canvas.width/analyzer.fftSize; let x=0;
for(let i=0;i<analyzer.fftSize;i+=2){ const v=timeData[i]/128; const y=v*(canvas.height/4)+centerY2;
if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y); x+=sliceWidth*2;}
ctx.strokeStyle=`rgba(255,255,255,${0.6+intensity*0.3})`; ctx.lineWidth=2; ctx.stroke();

// Center pulse
const pulseRadius=35+intensity*80, pulseAlpha=0.4+intensity*0.35;
const grad=ctx.createRadialGradient(centerX,centerY,0,centerX,centerY,pulseRadius);
grad.addColorStop(0,`hsla(${hueOffset%360},100%,95%,${pulseAlpha})`);
grad.addColorStop(0.4,`hsla(${(hueOffset+120)%360},80%,70%,${pulseAlpha*0.8})`);
grad.addColorStop(1,'transparent'); ctx.beginPath(); ctx.arc(centerX,centerY,pulseRadius,0,Math.PI*2); ctx.fillStyle=grad; ctx.fill();

animationFrameId=requestAnimationFrame(drawVisualizer);
}

// Audio setup
async function setupMicrophone(){try{stopVisualization();
stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});
setupAudioContext(stream); modeIndicator.textContent='Microphone Active'; modeIndicator.className='mode-indicator mode-mic';
micButton.disabled=true; tabButton.disabled=true; stopButton.disabled=false; welcomeOverlay.classList.add('hidden');
isVisualizing=true; particles.forEach(p=>p.reset()); animationFrameId=requestAnimationFrame(drawVisualizer);}catch(err){console.error(err); alert('Mic error: '+(err.message||err.name)); modeIndicator.textContent='Mic Error'; micButton.disabled=false; tabButton.disabled=false;}}

async function setupTabAudio(){try{stopVisualization();
if(!navigator.mediaDevices.getDisplayMedia)throw new Error('Tab audio only works in Chrome/Edge');
stream=await navigator.mediaDevices.getDisplayMedia({audio:true,video:true});
const videoTrack=stream.getVideoTracks()[0]; if(videoTrack)videoTrack.onended=()=>stopVisualization();
setupAudioContext(stream); modeIndicator.textContent='Tab Audio Active'; modeIndicator.className='mode-indicator mode-tab';
micButton.disabled=true; tabButton.disabled=true; stopButton.disabled=false; welcomeOverlay.classList.add('hidden');
isVisualizing=true; particles.forEach(p=>p.reset()); animationFrameId=requestAnimationFrame(drawVisualizer);}catch(err){console.error(err); if(err.name==='NotAllowedError'||err.name==='AbortError') alert('You cancelled the tab selection.'); else alert('Tab audio error: '+(err.message||err.name)); modeIndicator.textContent='Tab Audio Error'; micButton.disabled=false; tabButton.disabled=false;}}

function setupAudioContext(stream){
if(!audioContext||audioContext.state==='closed') audioContext=new (window.AudioContext||window.webkitAudioContext)();
if(audioContext.state==='suspended') audioContext.resume();
analyzer=audioContext.createAnalyser(); analyzer.fftSize=FFT_SIZE; analyzer.smoothingTimeConstant=SMOOTHING;
sourceNode=audioContext.createMediaStreamSource(stream); sourceNode.connect(analyzer);}

function stopVisualization(){
isVisualizing=false;
if(animationFrameId){ cancelAnimationFrame(animationFrameId); animationFrameId=null; }
if(stream){ stream.getTracks().forEach(track=>{try{track.stop();}catch(e){} }); stream=null; }
if(sourceNode){ try{sourceNode.disconnect();}catch(e){} sourceNode=null; }
if(analyzer){ try{analyzer.disconnect();}catch(e){} analyzer=null; }
ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#050515'; ctx.fillRect(0,0,canvas.width,canvas.height);
modeIndicator.textContent='No Audio Source'; modeIndicator.className='mode-indicator';
micButton.disabled=false; tabButton.disabled=!!(navigator.userAgent.includes('Chrome')||navigator.userAgent.includes('Edg'));
stopButton.disabled=true; welcomeOverlay.classList.remove('hidden'); }

micButton.addEventListener('click',setupMicrophone);
tabButton.addEventListener('click',setupTabAudio);
stopButton.addEventListener('click',stopVisualization);
});
</script>
</body>
</html>
